#!/bin/bash

source _head

_t bmilcs stow prepper

  # extract useful data
  cdir=$(pwd)
  bdir=$(pwd | sed 's/\/home\/.*\/\(.*\)/\1/')
  idir=$(pwd | sed 's/\/home\/'$USER'\/\(.*\)/\1/')
  ndir=$D/$bdir/$idir

  # debugging  
  # set -x  # debugging
   _i bdir: $bdir 
   _i idir: $idir
   _i ndir: $ndir 
   _i dot dir: $D

# no arguments:
if [ $# -eq 0 ] ; then
  # in $HOME?
  if [[ $bdir == *"home"* ]]; then
    _w \$HOME\ - really?
    exit 1
  # in dotfile repo dir?
  elif [[ $cdir == $D* ]]; then
    _w stow your stow - really?
    exit 1
  # does dir exist already?
  elif test -d "$ndir"; then
    _w $ndir already exists
  else
    _a creating $ndir
    mkdir -p $ndir
    if test -d $ndir; then
      _s successfully created: ../$bdir/$idir
    else
      _e something went wrong. unable to create folder.
      exit 3
    fi
  fi
fi

_ask "stow entire dir? (overwrites existing files)"

if [ $? == "1" ];then exit 0;fi

for d in * ; do
  # symlink test:    [[ -L $d ]]
  if [[ $d == *.log ]];then
    _w skipped $d
    continue
  elif [ -f $ndir/$d ]; then
    _ask "overwrite existing $d??"
    if [ $? == "1" ]; then
      _w skipping $d
      continue
    fi
    mv $ndir/$d $ndir/$d.bak
  fi
  mkdir -p $BAK/$bdir-$DATE
  _o copying \"$d\" to \"../$bdir/$idir\"
  cp $d $ndir/$d 2>/dev/null
  if test -f $ndir/$d; then
    _s
    rm $ndir/$d.bak 2>/dev/null
    mv $d $BAK/$bdir-$DATE/$d
  else
    _e copy failed! emergency exit.
    mv $ndir/$d.bak $ndir/$d 2>/dev/null
    exit 1
  fi 
done

_a stow time!
cd $D
stow $bdir
_s

#  mdir=$D/$1/$bdir
#  _a attempting to copy file over

#  mkdir -p $mdir
#  cp $2 $mdir
#  _s 
  

# 
# GRAVEYARD
#

#pwd | sed 's/\/home\/.*\/\(.*\)/\1/' | xargs mkdir -p 
