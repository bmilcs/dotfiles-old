#!/bin/bash

#
# STOWIFIER
# -bmilcs
#
# TODO: filename argument passed
# TODO: iteration, y/n per each file
# TODO: check if symlink, skip if so

source _head

_t bmilcs stow prepper

#
# EXTRACT DATA
#

cdir=$(pwd)
bdir=$(pwd | sed 's/\/home\/.*\/\(.*\)/\1/')
nbdir=${bdir,,}
idir=$(pwd | sed 's/\/home\/'$USER'\/\(.*\)/\1/')
ndir=$D/$nbdir/$idir

# debugging  
# set -x  # debugging
#  _i bdir: $bdir 
#  _i nbdir: $nbdir 
#  _i idir: $idir
#  _i ndir: $ndir 
#  _i dot dir: $D

#
# NO ARGUMENTS
#

# CREATE DIR STRUCTURE
if [ $# -eq 0 ] ; then
  # in $HOME?
  if [[ $bdir == *"home"* ]]; then
    _w \$HOME\ - really?
    exit 1
  # in dotfile repo dir?
  elif [[ $cdir == $D* ]]; then
    _w stow your stow - really?
    exit 1
  # does dir exist already?
  elif test -d "$ndir"; then
    _w $ndir already exists
  else
    _a creating $ndir
    mkdir -p $ndir
    if test -d $ndir; then
      _s successfully created: ../$nbdir/$idir
    else
      _e something went wrong. unable to create folder.
      exit 3
    fi
  fi

# STOW EVERYTHING?
  _ask "stow entire dir?"
  if [ $? == "1" ];then _s all set ; exit 0;fi

  # loop over all files
  for d in * ; do
    # TODO symlink test
    # skip log files
    if [[ $d == *.log ]];then
      _w skipped $d
      continue
    elif [ -f $ndir/$d ]; then
      _ask "overwrite existing $d??"
      if [ $? == "1" ]; then
        _w skipping $d
        continue
      fi
      mv $ndir/$d $ndir/$d.bak
    fi
    mkdir -p $BAK/$bdir-$DATE
    _o copying \"$d\" to \"../$nbdir/$idir\"
    cp -r $d $ndir/$d 2>/dev/null
    if test -f $ndir/$d; then
      _s
      rm $ndir/$d.bak 2>/dev/null
      mv $d $BAK/$bdir-$DATE/$d
    elif test -d $ndir/$d; then
      _s
      rm $ndir/$d.bak 2>/dev/null
      mv $d $BAK/$bdir-$DATE/$d
    else
      _e copy failed! emergency exit.
      mv $ndir/$d.bak $ndir/$d 2>/dev/null
      exit 1
    fi 
  done

#
# ARGUMENT TIME
#

else
  for f in $# ; do
    zsh

fi

# arg passed
# TODO INSERT HERE




# 
# CREATE SYMLINKS
#

_a stow time!
cd $D
stow -R $nbdir
_s success \!

