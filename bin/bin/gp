#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#                 UPDATE DOTFILES TEST [./updf]
#────────────────────────────────────────────────────────────

source _bm

D="${D:-/home/bmilcs/bm}"

if git rev-parse > /dev/null 2>&1; then
  gdir=$(git rev-parse --show-toplevel)
  g="git --git-dir=$gdir/.git --work-tree=$gdir"
else
  g="git --git-dir=$D/.git --work-tree=$D"
fi

gremote="$($g remote update 2> /dev/null)"
gstatus="$($g status -uno 2> /dev/null)"

# debugging
[ $# -gt 0 ] && _w "${GRN}${B}gstatus${YLW}: $gstatus" \
             && _w "${RED}${B}gremote${YLW}: $gremote" \
             && _w "${BLU}${B}g:${YLW} $g"

_a local repo

if [[ $gstatus == *"behind"* ]]; then

  _ew "${B}behind: updates available"

  if [[ $gstatus == *clean* ]] || [[ $gstatus == *"nothing to commit" ]]; then

    echo 
    $g pull

  else

    _f unable to update

  fi

elif [[ "$gstatus" == *"ahead"* ]]; then

  _ew ahead: pushing updates\\n
  $g push

else

  _sw "up-to-date"

fi

if [[ ! $gstatus == *clean* ]] && [[ ! $gstatus == *"nothing to commit"* ]]; then

  _ay "commit:"
  $g status -s
  echo

fi

if [[ $gstatus == *"diverged"* ]]; then

  _ar "repo has ${B}diverged!"
  _a attempting rebase\\n

  if git rebase; then 

    _s done\\n
    _ic "push updates (ahead)"
    $g push

  else

    _ww rebase unsuccessful\\n
    _ob "1. fix conflicts"
    $g status -s
    _ob "2. ${CYN}${B}git add${BLU} or ${CYN}${B}ga${BLU} (forgit)"
    _ob "3. ${CYN}${B}git rebase --continue${BLU} \
      or ${CYN}${B}grebc${BLU}, then ${CYN}${B}gp"

  fi
fi

# clean looking exit
echo
