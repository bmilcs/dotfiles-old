#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#                 UPDATE DOTFILES TEST [./updf]
#────────────────────────────────────────────────────────────

source _bm
_a local: dotfiles

D="${D:-/home/bmilcs/bm}"
g="git --git-dir=$D/.git --work-tree=$D"

# check modded files & pull remote status
gclean="$($g status | grep "clean")"
gremote="$($g remote update 2> /dev/null)"

# debugging
[ $# -gt 0 ] && _w "${GRN}${B}gstatus${YLW}: $gstatus" \
             && _w "${RED}${B}gremote${YLW}: $gremote"

if [[ ! -z "$gclean" ]] ; then

  _f clean

  _a remote dotfiles

  gstatus="$($g status -uno 2> /dev/null)"

  if [[ "$gstatus" == *"behind"* ]]; then

    _ic "pulling updates (behind)"
    $g pull

  elif [[ "$gstatus" == *"ahead"* ]]; then

    _ic "pushing updates (ahead)"
    $g push

  else
    _f "up-to-date"
  fi

else

  $g push

  _wb "dirty!"
  _ay "commit:"
  $g status -s

fi

if [[ $gstatus == *"diverged"* ]]; then
  _tr "repo has ${B}diverged!"
  _a attempting rebase
  if greb; then 
    _s 
  else
    _ww rebase unsuccessful\\n
    _ob "1. fix conflicts via ${CYN}${B}vim"
    _ob "2. ${CYN}${B}git add${BLU} or ${CYN}${B}ga${BLU} (forgit)"
    _ob "3. ${CYN}${B}git rebase --continue${BLU} \
      or ${CYN}${B}grebc${BLU}, then ${CYN}${B}gp"
  fi
fi

echo
_s done "\n"
