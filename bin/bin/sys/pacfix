#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com

#                 PACFIX [./pacfix]

source _bm

_a pacfix

#───────────────────────────────────────────────────  init output file  ───────

paclist=/tmp/pacfix
rm "$paclist"{,.final} &> /dev/null

#───────────────────────────────────────────────────  course of action  ───────

# no args
if [[ $# == 0 ]]; then

  _a "capturing output: yay -Syyuu"
  yay -Syyuu --noconfirm 2>&1 | tee "$paclist" && _s "done\n"

elif [[ $* == "1" ]]; then

  _a "[debug] capturing output: yay -Syyuu"
  yay -Syyuu --noconfirm 2>&1 | tee "$paclist" && _s "done\n"
  debug=1

# args contain pacman or yay
elif [[ $* == *"pacman|yay"* ]]; then

  _a "capturing output: \'$*\' (literal) "
  eval "$*" --noconfirm 2>&1 | tee "$paclist" && _s "done\n"

elif [[ -e "$*" ]]; then

  paclist="$*"

# args assumed to be package names
else

  _a "fixing broken packages: $*"
  for pkg in "$@"
  do
    _a "adding: $pkg"
    echo "$pkg" >> "$paclist".final
    _s "done"
  done

fi

#──────────────────────────────────────────────────  cleanup raw input   ──────

if [ -s "$paclist" ]; then 

  # debug
  [[ $debug == "1" ]] && _wb "initial pacman output  [\n" && cat "$paclist" \
    && echo && _wb "]"

  # cleanup pacman/yay output
  _a parsing output for broken packages

  # delete lines not containing 'exists in filesystem'
  sed -i '/exists in filesystem/!d' "$paclist"  

  [[ $debug == "1" ]] && echo && _w "deleted lines w/o exists in filesystem \
    [\n" && cat "$paclist" && echo && _w "]\n"

  # check if any packages remain, after clean-up
  if [ -s "$paclist" ]; then
    _iy "errors found!\n"
  else
    _i "no errors found"
    _s "done\n"
    exit 0
  fi

  sed -i 's/\: \/.*//g' "$paclist"

  [[ $debug == "1" ]] && _wg "sed: package names [\n" && cat "$paclist" \
    && echo && _wg "]"

  awk '!seen[$0]++' "$paclist" > "$paclist".final 

  [[ $debug -eq 1 ]] && _wc "final list [\n" && cat "$paclist".final \
    && echo && _wc "]"

  _s "done"

#──────────────────────────────────────────────────  specific packages  ───────

elif [ -n "$paclist".final ]; then
  echo
else
  _e "no output to parse"
  exit 1
fi

#_a pacman: forcing overwrite
_a yay time

while read x; do
  echo "fixing $x"
  yay -S --noconfirm --overwrite "*" "$x" &> /dev/null \
    && echo "> done!"
done <"$paclist".final

# clean up
rm "$paclist"{,.final} 2&>1 /dev/null
