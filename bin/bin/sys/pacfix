#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com

#                 PACFIX [./pacfix]

source _bm

_a pacfix

paclist=/tmp/pacfix
rm "$paclist"{,.final} 2> /dev/null

# determine command (no args = update)
_a "capturing output"
if [[ $# == 0 ]]; then
  yay -Syyyuuu --noconfirm 2>&1 | tee "$paclist" && _s done
elif [[ $* == *"pacman"* ]]; then
  eval "$*" --noconfirm 2>&1 | tee "$paclist" && _s done
elif [[ -e "$*" ]]; then
  paclist="$*"
else
  _e "bee bop. not sure what you're trying to do"
  exit 1
fi

[ $# -gt 0 ] && _w "initial pacman output  [" && cat "$paclist" && _w "]"

_a parsing output for broken packages

sed -i '/exists in filesystem/!d' "$paclist"  
[ $# -gt 0 ] && _w "deleted useless lines [" && cat "$paclist" && _w "]"

if [ -s "$paclist" ]; then
  _iy "package errors found!"
else
  _i "no errors need fixin'"
  _s done
  exit 0
fi

sed -i 's/\: \/.*//g' "$paclist"
[ $# -gt 0 ] && _w "sed: package names [" && cat "$paclist" && _w "]"

awk '!seen[$0]++' "$paclist" > "$paclist".final 
[ $# -gt 0 ] && _w "final list [" && cat "$paclist" && _w "]"
_s done

_a pacman: forcing overwrite
while read x; do
  echo "fixing $x"
  sudo pacman -S --noconfirm --overwrite "*" "$x" &> /dev/null \
    && echo "> done!"
done <"$paclist".final
rm "$paclist"{,.final}
