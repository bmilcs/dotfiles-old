#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#                 BMILCS USER UID/GID SETUP [./bmilcs-user-setup]
#────────────────────────────────────────────────────────────

source _bm
_tb bmilcs user uid/gid setup

bmUID=$(id -u bmilcs)
bmGID=$(id -g bmilcs)

if [[ $bmUID -ne "1086" ]]; then
  fixUID="1"
  _e "bmilcs user id: ${B}$bmUID"
else
  fixUID="0"
  _s "bmilcs user id: ${B}$bmUID"

fi

if [[ $bmGID -ne "1190" ]]; then
  fixGID="1"
  _e "bmilcs group id: ${B}$bmGID"
else
  fixGID="0"
  _s "bmilcs group id: ${B}$bmGID"
fi

[[ $fixGID -eq 1 ]] \
  && _a "fixing bmilcs UID" \
  && sudo usermod -u 1086 bmilcs \
  && _s "done"
[[ $fixUID -eq 1 ]] \
  && _a "fixing bmilcs GID" \
  && sudo groupmod -G 1190 bmilcs \
  && _s "done"

numreg='^[0-9]+$'

if _ask "fix files owned by original USER id?"; then

  _q "original USER id?"
  read origUID

  if ! [[ $origUID =~ $numreg ]]; then
    _e "manual id override ($origUID): NOT a number"
    exit 1
  fi

  _a USER id file ownership
  _o "old: $origUID"
  _o "new: $bmUID"
  _f starting now...

# for i in `find / -user $origUID`; do 
#   chown $bmUID $i
# done

  sudo find / -user "$origUID" \
    -path /cloud -prune -o \
    -path /cloud2 -prune -o \
    -path /all -prune -o \
    -path /vault -prune -o \
    -exec chown -h bmilcs {} \;
  fi

if _ask "fix files owned by original GROUP id?"; then

  _q "original GROUP id?"
  read origGID

  if ! [[ $origGID =~ $numreg ]]; then
    _e "manual id override ($origGID): NOT a number"
    exit 1
  fi

  _a GROUP id file ownership
  _o "old: $origGID"
  _o "new: $bmGID"
  _f starting now...

# for i in `find / -user $origUID`; do 
#   chown $bmUID $i
# done

  sudo find / -group "$origGID" \
    -path /cloud -prune -o \
    -path /cloud2 -prune -o \
    -path /all -prune -o \
    -path /vault -prune -o \
    -exec chgrp -h bmilcs {} \;
fi


