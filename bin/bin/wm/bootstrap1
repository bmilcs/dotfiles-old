#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#               GLOBAL BOOTSTRAP

#───────────────────────────────────────────────────────────────  init  ───────

log="$BMLOGS/bootstrap1.log"

bmlog() {
  unset len extra str
  str="#---> $* "
  len=${#str}
  len=$((35-len))
  for ((i=0; i<"$len"; i++))
  do
    extra+="-"
  done
  echo "$str $extra $(date +%Y.%m.%d-%H-%M-%S)"
  echo "$str $extra $(date +%Y.%m.%d-%H-%M-%S)" >> "$log"_"$1"
}

bmlog "BOOSTRAP1 START"

#──────────────────────────────────────────────────────────────  audio  ──────#

# note: attempting swap to user services via systemd

## pulseaudio
#pgrep -f pulseaudio \
#  || bmlog "pulseaudio" \
#  && pulseaudio --start | tee -a "$log"_pulse &
#
## mpd
#[ ! -s ~/.config/mpd/pid ] && bmlog mpd && mpd &>> "$log"_mpd &
# pgrep -f mpd && bmlog mpd && mpd &

#──────────────────────────────────────────────────────────────  input  ──────#

# keyboard: repeat rate
bmlog "xset_repeat"
xset r rate 300 50 &>> "$bmlog"_xsetrate

# keyboard: disable caps altogether
if [[ $(hostname) == "bmPC" ]]; then
  bmlog "xset_disablecaps"
  xset -q | grep "Caps Lock:\s*on" \
    && xdotool key Caps_Lock &>> "$bmlog"_xset_disablecaps
else
  # make capslock behave like ctrl:
  bmlog "setxkbmap -option ctrl:nocaps"
  setxkbmap -option ctrl:nocaps
fi

# make short-pressed Ctrl behave like Escape:
xcape -e 'Control_L=Escape'

# keyboard: caps = esc (tap)
pgrep -f xcape \
  || bmlog "xcape_ctrl_escape" \
  && xcape -e 'Control_L=Escape' &>> "$log"_xcape_ctrl_escape

#─────────────────────────────────────────────────────────────  system  ──────#

# usb automount (TODO FIX)
pgrep -f udiskie \
  || bmlog "udiskie" \
  && udiskie &>> "$log"_udiskie &

# compositor
pgrep -f picom \
  || bmlog "picom" \
  && picom -bc --config ~/.config/picom/config &>> "$log"_picom &

# wallpaper
pgrep -f nitrogen \
  || bmlog "nitrogen" \
  && nitrogen --restore &>> "$log"_nitrogen &

# mouse: autohide
pgrep -f unclutter \
  || bmlog "unclutter" \
  && unclutter &>> "$log"_unclutter &

# polybar (giving apps a second to load)
sleep 0.5
bmlog "polybar" \
  && sh "$HOME/.config/polybar/launch.sh" &>> "$log"_polybar &

# pgrep -f polybar || bmlog polybar && sh "$HOME/.config/polybar/launch.sh" &>> "$log"_polybar &

bmlog "BOOSTRAP1_STOP"

#───────────────────────────────────────────────────  concatenate logs  ──────#

for file in "$log"_*
do
  bat "$file" >> "$log"
  rm "$file"
done

exit 0

#──────────────────────────────────────────────────────────  graveyard  ──────#

# pgrep -f pulseaudio || pulseaudio --start &
# pgrep -f picom || picom --experimental-backends --config ~/.config/picom/config &
# pgrep -f blueman-tray || blueman-applet &

# # keyboard: caps = ctrl (hold)
# bmlog setxkbmap
# setxkbmap -option ctrl:nocaps &>> "$log"_
# bmlog xmodmap caps rshift etc
# xmodmap ~/.xmodmap

# # kde connect indicator
# bmlog kde_connect_indicator
# pgrep -f kdeconnect-indicator || kdeconnect-indicator &>> "$log"_kde_connect_indicator

