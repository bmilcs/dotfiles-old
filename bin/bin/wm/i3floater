#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#                 I3 FLOATER [./i3floater]
#────────────────────────────────────────────────────────────

source _bm 
_a i3 floater

who=$(hostname)
prevent=("Navigator" "Alacritty")

_o extracting class
class="$(xprop -id "$(xdotool getactivewindow)" \
  | grep -hn "WM_CLASS" \
  | cut -f1 -d"," \
  | cut -f3 -d " " \
  | cut -f2 -d "\"")"

eval "$(xwininfo -id "$(xdotool getactivewindow)" \
  | sed -n -e "s/^ \+Absolute upper-left X: \+\([0-9]\+\).*/x=\1/p" \
    -e "s/^ \+Absolute upper-left Y: \+\([0-9]\+\).*/y=\1/p" \
    -e "s/^ \+Width: \+\([0-9]\+\).*/w=\1/p" \
    -e "s/^ \+Height: \+\([0-9]\+\).*/h=\1/p")"

if [[ -z "$class" ]] ; then

  _e unable to extract classname
  _ne "unable to extract classname"
  exit 1

else 
  
  # class var filled
  # compare to $prevent
  unset skipped

  for a in "${prevent[@]}"; do
    [[ $class == "$a" ]] && skipped=1
  done

  if [[ -n $skipped ]] ; then

    _ne  "class: \"$class\" matches predefined '\$prevent' variable"
    exit 1

  elif [[ -z "$x" ]] || [[ -z "$y" ]] \
    || [[ -z "$h" ]] || [[ -z "$w" ]] \
    || [[ -z "$class" ]]; then

    _ne "unable to extract position or dimensions for class: \'"$class"\'"
  fi
fi

_n "class = $class"
_o class: \""$class"\"
_s 

line="\
for_window [instance=\""$class"\"] \
floating enable, \
resize set $w $h, \
move absolute position $x $y, \
border pixel 3"

echo $line

[[ $who == "bmPC" ]] \
  && _a "bmPC recognized." \
  && [[ -w ~/.config/i3/bmPC ]] \
  && conf=~/.config/i3/bmPC \
  && _n "bmPC conf set"

[[ -z "$conf" ]] \
  && _e "$who, you're not bmPC." \
  && _w "assuming you don\'t have an ultrawide and 27\" vertical stack setup" \
  && _a "bmTP mode it is, then." \
  && [[ -w ~/.config/i3/bmTP ]] \
  && conf=~/.config/i3/bmTP \
  && _n "bmTP conf set"

# check if rule exists already
# if grep -F "instance=\"$class\"" "$conf"; then
#   _n "[class=\"$class\"] \na floating rule class exists already! "
# fi
# 
# cp "$conf"{,.bak}
# 
# comment out old line
#sed '/^for_window.*instance=\"'"$class"'\"/ s/^#*/#/' -i "$conf"

sed -i '/^for_window.*instance=\"'"$class"'\"/d' "$conf"

echo "$line" >> "$conf" #|| _ne "unable to insert i3 conf line to config!" && exit 0

if grep -F "instance=\"$class\"" "$conf"; then
  i3makeconf && _ns "i3 config mods inserted successfully for: $class.\n\
    Now restarting for changes to take effect"
  i3-msg "restart"
  #_ns "[class=\"$class\"] \na floating rule added successfully!"
fi

