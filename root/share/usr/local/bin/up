#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#                DISTRO-BASED SYSTEM UPDATE
#────────────────────────────────────────────────────────────

source _head
source _distro

if [[ $DISTRO = arch* ]]; then

  #
  # ARCH
  #

  # yay
  _a pacman/aur
  if [[ $# == 0 ]]; then
    yay -Syyyuuu && _s
  else
    _o skipped: debugging
  fi

  # repos: once daily
  _a repos
  if [[ -L /usr/local/bin/upr ]]; then
    rstatus="$HOME/.config/up/repos.bm"
    today="$(date +"%Y-%m-%d" | cut -d'-' -f 3)"

    if [ -f "$rstatus" ]; then
      rlast="$(cat "$rstatus")"
    else
      mkdir -p ~/.config/up
      rlast="00"
    fi

    if [[ ! "$today" == "$rlast" ]]; then
      _i "running: daily update for $DAYOFWEEK" "\n"
      upr && echo "$today" > "$rstatus" && echo && _s "\n"
    else _o skipped: "${DAYOFWEEK,,}'s update completed earlier today"; fi

  fi

  # ARCH END

elif [[ $DISTRO = debian* ]]; then

  #
  # DEBIAN
  #

  _a apt full-upgrade
  sudo apt full-upgrade -y && _s

  _a apt autoremove
  sudo apt autoremove -y && _s

  _a apt clean
  sudo apt clean -y && _s

  _a apt autoclean
  sudo apt autoclean -y && _s

  # DEBIAN END

else

  # UNCONFIGURED
  _e unknown distro\! update me\!\! && _i \"/usr/local/bin/up\"

fi

#
# BONUS
#

# pihole
if pihole -v PIHOLE &> /dev/null; then
  _a pihole -up
  sudo pihole -up
fi

# docker
if docker-compose -v DOCKER-COMPOSE &> /dev/null; then
  dcr
fi

#
# CLEAN EXIT
#

echo
exit 0
