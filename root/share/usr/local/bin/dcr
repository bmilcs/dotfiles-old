#!/usr/bin/env bash
#  ▄▄▄▄· • ▌ ▄ ·. ▪  ▄▄▌   ▄▄· .▄▄ ·   ──────────────────────
#  ▐█ ▀█▪·██ ▐███▪██ ██•  ▐█ ▌▪▐█ ▀.   ╔╦╗╔═╗╔╦╗╔═╗╦╦  ╔═╗╔═╗
#  ▐█▀▀█▄▐█ ▌▐▌▐█·▐█·██ ▪ ██ ▄▄▄▀▀▀█▄   ║║║ ║ ║ ╠╣ ║║  ║╣ ╚═╗
#  ██▄▪▐███ ██▌▐█▌▐█▌▐█▌ ▄▐███▌▐█▄▪▐█  ═╩╝╚═╝ ╩ ╚  ╩╩═╝╚═╝╚═╝
#  ·▀▀▀▀ ▀▀  █▪▀▀▀▀▀▀.▀▀▀ ·▀▀▀  ▀▀▀▀   https://dot.bmilcs.com
#                 DOCKER-COMPOSE & REPO UPDATE [./dcr]
#────────────────────────────────────────────────────────────
# UPDATE DOCKER
#────────────────────────────────────────────────────────────
source _bm
_t docker-compose

cd ~/docker || (_e "~/docker missing!" && exit 1)

# clean up docker system
dclean() {
  docker rm $(docker ps -qa --no-trunc --filter "status=exited") 2> /dev/null
  docker rmi $(docker images --filter "dangling=true" -q --no-trunc)
}



_a docker-compose down && docker-compose down && _s

_a docker-compose pull && docker-compose pull && _s

_a docker-compose up -d --remove-orphans && docker-compose up -d --remove-orphans && _s

#────────────────────────────────────────────────────────────
# COMMIT/PUSH GIT UPDATES
#────────────────────────────────────────────────────────────

_a docker git

docdir="${docdir:-/home/bmilcs/docker}"
docgit="/usr/bin/git --git-dir="$docdir"/.git --work-tree="$docdir""
docclean="$($docgit status | grep "clean")"

_o checking for undocumented edits

if [[ ! -z "$docclean" ]] ; then
  _s clean: no action necessary
else
  _w mods found
  _a commit
  $docgit commit -a -m "automated update" \
    && _s \
    && _a pushing \
    && $docgit push \
    && _s done
fi

_ay docker cleanup
_f "$ dclean"
if _ask run now? ${B}dclean; then
  dclean
fi
